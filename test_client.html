<!DOCTYPE html>
<html>
<head>
    <title>Finders Keepers Test Client</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #game-area { 
            width: 600px; 
            height: 400px; 
            border: 2px solid #333; 
            position: relative;
            background-color: #f0f0f0;
            margin: 20px 0;
        }
        .player {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 10px;
        }
        .current-player { background-color: #ff0000; }
        .other-player { background-color: #0066cc; }
        #controls { margin: 10px 0; }
        #log { 
            height: 200px; 
            overflow-y: scroll; 
            border: 1px solid #ccc; 
            padding: 10px;
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <h1>Finders Keepers Test Client</h1>
    
    <div>
        <input type="text" id="playerName" placeholder="Enter your name" value="TestPlayer">
        <button id="connect">Connect</button>
        <button id="disconnect" disabled>Disconnect</button>
        <span id="status">Disconnected</span>
    </div>
    
    <div id="controls">
        <p>Use WASD or Arrow Keys to move</p>
        <p>Position: (<span id="posX">0</span>, <span id="posZ">0</span>)</p>
    </div>
    
    <div id="game-area"></div>
    
    <div>
        <h3>Server Messages Log:</h3>
        <div id="log"></div>
    </div>

    <script>
        let socket = null;
        let playerId = null;
        let position = { x: 300, y: 0, z: 200 }; // Start in center
        let players = new Map();
        
        const connectBtn = document.getElementById('connect');
        const disconnectBtn = document.getElementById('disconnect');
        const status = document.getElementById('status');
        const gameArea = document.getElementById('game-area');
        const log = document.getElementById('log');
        const posX = document.getElementById('posX');
        const posZ = document.getElementById('posZ');

        function updateStatus(text, color = 'black') {
            status.textContent = text;
            status.style.color = color;
        }

        function logMessage(message) {
            const timestamp = new Date().toLocaleTimeString();
            log.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            log.scrollTop = log.scrollHeight;
        }

        function updatePosition() {
            posX.textContent = Math.round(position.x);
            posZ.textContent = Math.round(position.z);
        }

        function createPlayerElement(player, isCurrentPlayer = false) {
            const playerEl = document.createElement('div');
            playerEl.className = `player ${isCurrentPlayer ? 'current-player' : 'other-player'}`;
            playerEl.id = `player-${player.id}`;
            playerEl.textContent = player.name.charAt(0).toUpperCase();
            playerEl.title = player.name;
            
            // Convert world coordinates to screen coordinates
            playerEl.style.left = `${player.x}px`;
            playerEl.style.top = `${player.z}px`;
            
            return playerEl;
        }

        function updatePlayerDisplay(player, isCurrentPlayer = false) {
            let playerEl = document.getElementById(`player-${player.id}`);
            if (!playerEl) {
                playerEl = createPlayerElement(player, isCurrentPlayer);
                gameArea.appendChild(playerEl);
            } else {
                playerEl.style.left = `${player.x}px`;
                playerEl.style.top = `${player.z}px`;
            }
        }

        function removePlayer(playerId) {
            const playerEl = document.getElementById(`player-${playerId}`);
            if (playerEl) {
                playerEl.remove();
            }
            players.delete(playerId);
        }

        connectBtn.addEventListener('click', () => {
            const playerName = document.getElementById('playerName').value || 'TestPlayer';
            
            // Generate a UUID for this client
            playerId = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
            
            socket = new WebSocket('ws://37.27.225.36:8087');
            
            socket.onopen = () => {
                updateStatus('Connected', 'green');
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                logMessage('Connected to server');
                
                // Send join message with client-generated UUID
                const joinMessage = {
                    type: 'Join',
                    player_id: playerId,
                    player_name: playerName
                };
                socket.send(JSON.stringify(joinMessage));
                logMessage(`Sent join request as "${playerName}" with ID ${playerId}`);
            };
            
            socket.onmessage = (event) => {
                const message = JSON.parse(event.data);
                logMessage(`Received: ${JSON.stringify(message)}`);
                
                switch (message.type) {
                    case 'GameState': {
                        // Clear existing players and update with new state
                        gameArea.innerHTML = '';
                        players.clear();
                        
                        message.players.forEach(player => {
                            players.set(player.id, player);
                            const isCurrentPlayer = player.id === playerId;
                            updatePlayerDisplay(player, isCurrentPlayer);
                        });
                        break;
                    }
                        
                    case 'PlayerJoined': {
                        const newPlayer = {
                            id: message.player_id,
                            name: message.player_name,
                            x: message.x,
                            y: message.y,
                            z: message.z
                        };
                        players.set(message.player_id, newPlayer);
                        updatePlayerDisplay(newPlayer, message.player_id === playerId);
                        
                        if (message.player_id === playerId) {
                            // This is us joining
                            position.x = message.x;
                            position.z = message.z;
                            updatePosition();
                            logMessage(`You joined as player ${playerId}`);
                        }
                        break;
                    }
                        
                    case 'PlayerMoved': {
                        if (players.has(message.player_id)) {
                            const player = players.get(message.player_id);
                            player.x = message.x;
                            player.y = message.y;
                            player.z = message.z;
                            updatePlayerDisplay(player, message.player_id === playerId);
                        }
                        break;
                    }
                        
                    case 'PlayerLeft': {
                        removePlayer(message.player_id);
                        logMessage(`Player ${message.player_id} left`);
                        break;
                    }
                        
                    case 'Error': {
                        logMessage(`Server error: ${message.message}`);
                        break;
                    }
                }
            };
            
            socket.onclose = () => {
                updateStatus('Disconnected', 'red');
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                playerId = null;
                gameArea.innerHTML = '';
                players.clear();
                logMessage('Disconnected from server');
            };
            
            socket.onerror = (error) => {
                logMessage(`WebSocket error: ${error}`);
                updateStatus('Connection Error', 'red');
            };
        });

        disconnectBtn.addEventListener('click', () => {
            if (socket) {
                socket.close();
            }
        });

        // Handle keyboard input for movement
        document.addEventListener('keydown', (event) => {
            if (!socket || socket.readyState !== WebSocket.OPEN || !playerId) return;
            
            const moveSpeed = 1;
            let moved = false;
            
            switch (event.key.toLowerCase()) {
                case 'w':
                case 'arrowup':
                    position.z = Math.max(0, position.z - moveSpeed);
                    moved = true;
                    break;
                case 's':
                case 'arrowdown':
                    position.z = Math.min(380, position.z + moveSpeed);
                    moved = true;
                    break;
                case 'a':
                case 'arrowleft':
                    position.x = Math.max(0, position.x - moveSpeed);
                    moved = true;
                    break;
                case 'd':
                case 'arrowright':
                    position.x = Math.min(580, position.x + moveSpeed);
                    moved = true;
                    break;
            }
            
            if (moved) {
                updatePosition();
                
                // Send position update to server
                const moveMessage = {
                    type: 'UpdatePosition',
                    x: position.x,
                    y: position.y,
                    z: position.z
                };
                socket.send(JSON.stringify(moveMessage));
                
                // Update our own player display
                if (players.has(playerId)) {
                    const player = players.get(playerId);
                    player.x = position.x;
                    player.z = position.z;
                    updatePlayerDisplay(player, true);
                }
            }
        });

        // Initialize position display
        updatePosition();
    </script>
</body>
</html>
